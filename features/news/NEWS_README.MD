# ğŸ“° MÃ³dulo de Novedades

Este documento explica la estructura, el flujo de datos y la interacciÃ³n entre los componentes del **mÃ³dulo de novedades**, que permite crear, editar, mostrar y eliminar noticias dentro del panel administrativo.

---

## ğŸ“ Ruta del mÃ³dulo

- /dashboard/news

---

## âš™ï¸ ComunicaciÃ³n backend

### Archivos principales:

- **`news.ts`** â†’ Gestiona la comunicaciÃ³n con el esquema `news` en la base de datos y con el bucket de almacenamiento (`storage`) en Supabase.
- **`tags.ts`** â†’ Gestiona la tabla de **tags**, utilizada para la categorizaciÃ³n de las novedades.

> Ambos scripts trabajan en conjunto para que las novedades puedan tener etiquetas, imÃ¡genes y contenido enriquecido.

---

## ğŸ§­ Flujo de componentes frontend

El flujo general de renderizado y comunicaciÃ³n se organiza de la siguiente forma:

### 1. `dashboard/news/page.tsx` _(Server Component)_

- Es el **punto de entrada principal** del mÃ³dulo.
- Solicita la informaciÃ³n de las novedades existentes y sus caracterÃ­sticas desde los scripts:
  - `news.ts`
  - `tags.ts`
- EnvÃ­a la informaciÃ³n obtenida al componente `news.tsx`, que se encarga de mostrar y gestionar las novedades.
- `page.tsx` â”€â”€â–¶ `news.tsx` â”€â”€â–¶ `NewsList.tsx` / `newsForm.tsx`

---

### 2. `news.tsx` _(Client Component)_

Este componente actÃºa como **controlador dinÃ¡mico** del mÃ³dulo de novedades.

#### Funciones principales:

- Renderiza el listado de novedades existentes.
- Gestiona la animaciÃ³n y la interacciÃ³n de los distintos elementos.
- Determina cuÃ¡ndo mostrar el formulario de creaciÃ³n o ediciÃ³n.

#### Subcomponentes:

- **`NewsList.tsx`**
  - Recibe los datos de cada novedad desde `news.tsx`.
  - Renderiza cada elemento y convierte el formato `docs` (estructura de TipTap) en contenido visual.
  - Permite las acciones **Editar** y **Borrar** sobre cada novedad.

- **`newsForm.tsx`**
  - Se utiliza tanto para **crear** como para **editar** una novedad.
  - Si se estÃ¡ creando una nueva novedad, se asigna el identificador:
    ```ts
    id = -1;
    ```
  - Recibe tambiÃ©n la lista de `tags` desde `tags.ts`.

---

### 3. `newsForm.tsx` _(Client Component principal)_

Es el **nÃºcleo del sistema de novedades**.

#### Responsabilidades:

- Mantiene el **estado completo** de una novedad en ediciÃ³n o creaciÃ³n.
- Se comunica con el **editor de texto enriquecido TipTap**, configurado en `tiptap-editor.tsx`.
- Gestiona la subida, actualizaciÃ³n y eliminaciÃ³n de imÃ¡genes vinculadas al contenido.

#### InteracciÃ³n con el editor TipTap:

- Se comunican mediante funciones callback:
  - `onChange` â†’ actualiza el estado local de la novedad.
  - `onAddImage` â†’ gestiona la subida de una nueva imagen al bucket.
  - `onRemoveImage` â†’ elimina una imagen del bucket y actualiza su referencia en el contenido.
- Cada nodo del editor (texto, imagen, encabezado, etc.) mantiene coherencia entre su estado y el formato `JSON` de TipTap.

#### Server Actions:

`newsForm.tsx` invoca dos acciones del servidor:

- `createNews()` â†’ Crea una nueva novedad en la base de datos.
- `updateNews()` â†’ Actualiza una novedad existente.

#### Manejo de imÃ¡genes:

Las imÃ¡genes se gestionan mediante funciones importadas de `news.ts`:

- `uploadNewImage()` â†’ Sube una nueva imagen al bucket `Novedades`.
- `moveExistingImage()` â†’ Mueve imÃ¡genes cuando se modifica el tÃ­tulo o la ruta de la novedad.

##### ğŸ“Œ ConvenciÃ³n de nombres:

- Los archivos subidos al bucket siguen una convenciÃ³n **snake-case + timestamp ISO**, garantizando nombres Ãºnicos.
- ejemplo: titulo-novedad-2025-10-13T12-30-04Z.png

#### ActualizaciÃ³n de URLs:

Para mantener las rutas correctas de las imÃ¡genes al modificar tÃ­tulos o rutas, se utilizan funciones del archivo `tiptap-images-src.ts`:

- `extractImageSrcsFromJSON()`
- `replaceImageSrcsInJSON()`

Estas funciones permiten analizar y actualizar los atributos `src` de cada nodo `image` dentro del contenido TipTap.

---

## ğŸ§© LibrerÃ­as y componentes utilizados

### ğŸ§± **shadcn/ui**

Componentes prearmados para una interfaz moderna y consistente:

- `Sonner` / `Toast` â†’ Notificaciones rÃ¡pidas.
- `Button` â†’ Botones estilizados.
- `AlertDialog` â†’ Confirmaciones de acciones crÃ­ticas.
- `Tooltip` â†’ Ayuda contextual.

### ğŸ **motion (framer-motion)**

Utilizado para animar la apariciÃ³n y transiciÃ³n de componentes en pantalla, mejorando la experiencia del usuario.

---

## ğŸ§  Resumen conceptual del flujo

```text
(page.tsx) â”€â”€ obtiene datos del backend
 â”‚
 â–¼
(news.tsx) â”€â”€ renderiza lista y controla interacciÃ³n
 â”œâ”€â”€ NewsList.tsx â†’ muestra novedades
 â””â”€â”€ newsForm.tsx â†’ crea / edita novedades
         â”‚
         â–¼
 (tiptap-editor.tsx) â”€â”€ editor de texto enriquecido
         â”‚
         â–¼
 (Supabase storage + base de datos)
```

---

## ProblemÃ¡tica de los atributos del nodo Heading

- Next.js (y en general Web APIs) usan el algoritmo de structured clone cuando pasan objetos entre capas (o internamente Next hace serializaciones).
- JSON.stringify elimina propiedades cuyo valor sea undefined. TambiÃ©n clases con getters/setters poco comunes, funciones, sÃ­mbolos, etc.
- Si tus nodos contienen attrs pero en algÃºn momento alguna propiedad quedÃ³ undefined (por ejemplo width: undefined) la propiedad entera puede desaparecer al serializar, o la estructura puede transformarse.
- Resultado: cliente muestra attrs antes de invocar el Server Action (porque en la memoria del navegador todavÃ­a estaban), pero lo que llega al server es una versiÃ³n ya â€œlimpiaâ€ (sin keys undefined) o incluso con attrs ausentes en algunos nodos.

### SOLUCION

1. Normalizar el JSON de TipTap en el cliente para garantizar que todos los nodos tengan attrs explÃ­citos (no undefined) y que los heading contengan level si correspondiera, etc.
2. Serializar explÃ­citamente (hacer JSON.stringify) y enviar una cadena a la Server Action. En el servidor JSON.parse y validar/usar el objeto parsed. Esto elimina cualquier ambigÃ¼edad del paso de parÃ¡metros y de la clonaciÃ³n estructurada.

## ğŸª„ Notas finales

- El formato `docs` almacenado en la base de datos es la estructura serializada del contenido TipTap.
- Cada cambio visual o estructural en el editor se refleja directamente en el JSON final.
- El sistema garantiza compatibilidad al editar novedades preexistentes, preservando el formato y las rutas multimedia.
- Los nombres Ãºnicos y los mÃ©todos de reemplazo aseguran integridad entre las URLs del contenido y los archivos en el bucket.

### âœï¸ Autor: Ohmia

### ğŸ—“ Ãšltima actualizaciÃ³n: Octubre 2025

### ğŸ“¦ TecnologÃ­as principales: Nextjs15, React, TypeScript, TipTap, Supabase, shadcn/ui, motion
